<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ArchivosYa ‚Äî Colaborativo con Autosave</title>
  <style>
    /* ---------- RESET / BASE ---------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#202124; }
    /* ---------- LOGIN ---------- */
    .login-container { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
    .login-box { background:#fff; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.25); padding:40px; width:100%; max-width:480px; }
    .login-logo { width:80px;height:80px;border-radius:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:700;margin:0 auto 16px; }
    .login-title { text-align:center; font-size:26px; font-weight:700; margin-bottom:6px; color:#202124; }
    .login-subtitle { text-align:center; color:#5f6368; margin-bottom:20px; font-size:14px; }
    .login-tabs { display:flex; border-bottom:2px solid #e0e0e0; margin-bottom:20px; }
    .login-tab { flex:1; padding:12px 0; text-align:center; cursor:pointer; font-weight:600; color:#5f6368; border-bottom:3px solid transparent; }
    .login-tab.active { color:#667eea; border-bottom-color:#667eea; }
    .form-group { margin-bottom:16px; }
    label { display:block; margin-bottom:8px; font-weight:600; color:#202124; font-size:14px; }
    input[type="text"], input[type="email"], textarea, select {
      width:100%; padding:12px 14px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px;
    }
    input:focus, textarea:focus, select:focus { outline:none; border-color:#667eea; }
    .btn-login { width:100%; padding:14px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer; transition:transform .15s, box-shadow .15s; }
    .btn-login:hover { transform:translateY(-2px); box-shadow:0 8px 16px rgba(102,126,234,0.35); }
    .error-message, .success-message {
      padding:12px;border-radius:8px;margin-bottom:12px;font-size:14px; display:none;
    }
    .error-message.show{ display:block; background:#ffecec; color:#b00000; }
    .success-message.show{ display:block; background:#e8f5e9; color:#2e7d32; }
    /* ---------- APP LAYOUT ---------- */
    .app-container { display:none; min-height:100vh; }
    .app-container.active { display:block; }
    .header { background:#fff; border-bottom:1px solid #e0e0e0; padding:12px 20px; display:flex; align-items:center; justify-content:space-between; }
    .header-left { display:flex; align-items:center; gap:14px; }
    .logo { display:flex; align-items:center; gap:8px; font-weight:600; color:#5f6368; }
    .logo-icon { width:36px;height:36px;border-radius:8px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .search-bar { width:520px; background:#f1f3f4; border-radius:8px; padding:8px 12px; display:flex; align-items:center; gap:8px; }
    .search-bar input { flex:1; border:none; background:transparent; outline:none; font-size:14px; }
    .user-section { display:flex; align-items:center; gap:12px; position:relative; }
    .user-name { font-weight:600; color:#202124; font-size:14px; }
    .user-email { font-size:12px; color:#5f6368; }
    .user-avatar { width:36px;height:36px;border-radius:50%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; font-weight:700; }
    .user-menu { position:absolute; top:100%; right:0; margin-top:8px; background:#fff; border:1px solid #e0e0e0; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.12); display:none; min-width:200px; z-index:1000; }
    .user-menu.active { display:block; }
    .user-menu-item { padding:10px 12px; display:flex; gap:10px; align-items:center; cursor:pointer; }
    .user-menu-divider { height:1px; background:#e0e0e0; margin:4px 0; }
    .main-container { display:flex; height:calc(100vh - 64px); }
    .sidebar { width:250px; background:#fff; border-right:1px solid #e0e0e0; padding:20px; }
    .new-button { display:flex; align-items:center; gap:10px; padding:10px 16px; border-radius:24px; border:1px solid #dadce0; background:#fff; cursor:pointer; margin-bottom:18px; font-weight:600; }
    .sidebar-nav { list-style:none; }
    .sidebar-item { padding:10px 12px; border-radius:8px; display:flex; gap:8px; align-items:center; cursor:pointer; margin-bottom:6px; }
    .sidebar-item.active { background:#e8f0fe; color:#1967d2; }
    .content { flex:1; overflow:auto; padding:22px; background: linear-gradient(#f8fbff00,#ffffff00); }
    .files-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(220px,1fr)); gap:18px; }
    .file-card { background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:12px; display:flex; justify-content:space-between; align-items:center; gap:10px; cursor:pointer; transition:transform .12s, box-shadow .12s; position:relative; }
    .file-card:hover { transform:translateY(-4px); box-shadow:0 6px 18px rgba(0,0,0,.06); border-color:#1967d2; }
    .file-card.locked { opacity:.55; cursor:not-allowed; }
    .file-card.locked::after { content:"üîí"; position:absolute; top:8px; right:8px; font-size:18px; color:#ff9800; }
    .file-icon { font-size:36px; margin-right:12px; display:flex; align-items:center; justify-content:center; width:60px; height:60px; border-radius:6px; }
    .file-icon.folder { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; }
    .file-icon.file { background:#f1f3f4; color:#5f6368; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:2000; align-items:center; justify-content:center; padding:20px; }
    .modal.active { display:flex; }
    .modal-content { width:100%; max-width:720px; background:#fff; border-radius:12px; padding:20px; box-shadow:0 14px 40px rgba(0,0,0,.25); }
    .modal-header { font-size:18px; font-weight:700; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; }
    .autosave-indicator { font-size:12px; color:#5f6368; font-weight:400; }
    .autosave-indicator.saving { color:#1967d2; }
    .autosave-indicator.saved { color:#2e7d32; }
    .modal-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:12px; }
    .btn { padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    .btn-primary { background:#1967d2; color:#fff; }
    .btn-secondary { background:#fff; color:#5f6368; border:1px solid #dadce0; }
    .loading { text-align:center; padding:40px; }
    .spinner { width:40px;height:40px;border:4px solid #f1f3f4;border-top:4px solid #1967d2;border-radius:50%; animation:spin 1s linear infinite;margin:0 auto 12px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .empty-state { text-align:center; padding:60px 20px; color:#5f6368; }
    .hidden { display:none; }
    .flex { display:flex; align-items:center; justify-content:center; }
  </style>
  <script type="module">
    import * as Y from 'https://cdn.jsdelivr.net/npm/yjs@13.6.5/+esm';
    window.Y = Y;
  </script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <!-- ===== LOGIN ===== -->
  <div class="login-container" id="loginContainer">
    <div class="login-box">
      <div class="login-logo">AY</div>
      <div class="login-title">ArchivosYa</div>
      <div class="login-subtitle">Tu sistema de gesti√≥n de archivos colaborativo</div>
      <div class="login-tabs">
        <div class="login-tab active" id="tabLogin" onclick="switchTab('login')">Iniciar Sesi√≥n</div>
        <div class="login-tab" id="tabRegister" onclick="switchTab('register')">Registrarse</div>
      </div>
      <div id="loginError" class="error-message"></div>
      <div id="loginSuccess" class="success-message"></div>
      <form id="loginForm" class="login-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" required placeholder="tu@email.com" />
        </div>
        <button class="btn-login" type="submit">Iniciar Sesi√≥n</button>
      </form>
      <form id="registerForm" class="login-form" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label for="registerName">Nombre de Usuario</label>
          <input id="registerName" type="text" required placeholder="Tu nombre" />
        </div>
        <div class="form-group">
          <label for="registerEmail">Email</label>
          <input id="registerEmail" type="email" required placeholder="tu@email.com" />
        </div>
        <button class="btn-login" type="submit">Crear Cuenta</button>
      </form>
    </div>
  </div>
  <!-- ===== APP ===== -->
  <div class="app-container" id="appContainer" aria-hidden="true">
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <div class="logo-icon">AY</div>
          <div>ArchivosYa</div>
        </div>
        <div class="search-bar">
          <div>üîç</div>
          <input id="searchInput" placeholder="Buscar archivos..." />
        </div>
      </div>
      <div class="user-section" id="userSection">
        <div>
          <div class="user-name" id="userName">Usuario</div>
          <div class="user-email" id="userEmail">usuario@email.com</div>
        </div>
        <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">U</div>
        <div class="user-menu" id="userMenu">
          <div class="user-menu-item" onclick="showProfile()">üë§ Mi Perfil</div>
          <div class="user-menu-divider"></div>
          <div class="user-menu-item" onclick="handleLogout()">üö™ Cerrar Sesi√≥n</div>
        </div>
      </div>
    </header>
    <div class="main-container">
      <aside class="sidebar">
        <button class="new-button" onclick="showNewModal()">‚ûï Nuevo</button>
        <ul class="sidebar-nav">
          <li class="sidebar-item active" onclick="loadFiles()">üìÅ Mi unidad</li>
          <li class="sidebar-item" onclick="loadShared()">üë• Compartido</li>
        </ul>
      </aside>
      <main class="content">
        <div id="loadingIndicator" class="loading hidden">
          <div class="spinner"></div>
          <div>Cargando...</div>
        </div>
        <div id="filesContainer" class="files-grid"></div>
        <div id="emptyState" class="empty-state hidden">
          <div style="font-size:64px; margin-bottom:12px;">üìÇ</div>
          <div>No hay archivos a√∫n. ¬°Crea uno nuevo!</div>
        </div>
      </main>
    </div>
  </div>
  <!-- Modal: Nuevo -->
  <div id="newModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">Crear nuevo</div>
      <div class="form-group">
        <label>Tipo</label>
        <select id="newType"><option value="file">Archivo</option><option value="folder">Carpeta</option></select>
      </div>
      <div class="form-group">
        <label>Nombre</label>
        <input id="newName" type="text" placeholder="Ingresa un nombre" />
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal('newModal')">Cancelar</button>
        <button class="btn btn-primary" onclick="createNew()">Crear</button>
      </div>
    </div>
  </div>
  <!-- Modal: Editar -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <span id="editName">Editar archivo</span>
          <div id="autosaveIndicator" class="autosave-indicator">üíæ Se guarda autom√°ticamente</div>
        </div>
        <button class="btn btn-secondary" style="margin:0;" onclick="closeAndUnlockEditModal()">‚úï Cerrar</button>
      </div>
      <div class="form-group">
        <textarea id="editContent" rows="18" style="width:100%; padding:10px; border:1px solid #dadce0; border-radius:6px; font-family:monospace; font-size:13px;"></textarea>
      </div>
    </div>
  </div>
  <!-- Modal: Compartir -->
  <div id="shareModal" class="modal" aria-hidden="true">
    <div class="modal-content" style="max-width:420px;">
      <div class="modal-header">Compartir archivo</div>
      <label class="form-group">üìß Email del destinatario</label>
      <input id="shareEmail" type="email" placeholder="ejemplo@correo.com" />
      <label class="form-group" style="margin-top:8px;">üîê Permiso</label>
      <select id="sharePermission">
        <option value="4">Lectura (r)</option>
        <option value="6">Lectura y escritura (rw)</option>
        <option value="7">Total (rwx)</option>
      </select>
      <div class="modal-actions" style="margin-top:12px;">
        <button class="btn btn-secondary" id="cancelShareBtn">Cancelar</button>
        <button class="btn btn-primary" id="confirmShareBtn">Compartir</button>
      </div>
    </div>
  </div>

<script>
/* ================== CONFIG ================== */
const API_URL = 'http://192.168.0.105:3000/api';
const socket = io('http://192.168.0.105:3000');

/* ================== ESTADO GLOBAL ================== */
let currentUser = null;
let currentUserId = null;
let currentFolderId = null;
let currentFileId = null;
let selectedShareTargetId = null;

// ‚úÖ Yjs
let ydoc = null;
let ytext = null;
let ignoreLocalEvent = false;

/* ================== SOCKET (TIEMPO REAL) ================== */
socket.on('fileLocked', ({ fileId, userId }) => {
  const card = document.querySelector(`.file-card[data-id="${fileId}"]`);
  if (card) {
    card.classList.add('locked');
    card.title = `Bloqueado por ${userId}`;
  }
});

socket.on('fileUnlocked', ({ fileId }) => {
  const card = document.querySelector(`.file-card[data-id="${fileId}"]`);
  if (card) {
    card.classList.remove('locked');
    card.title = '';
  }
});

socket.on('user:joined', ({ userId }) => {
  console.log(`üë§ ${userId} se uni√≥ al archivo`);
  updateAutosaveIndicator('Otro usuario editando...');
});

socket.on('user:left', ({ userId }) => {
  console.log(`üëã ${userId} sali√≥ del archivo`);
});

/* ================== INICIALIZACI√ìN / SESI√ìN ================== */
window.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('archivosya_user');
  if (saved) {
    try {
      currentUser = JSON.parse(saved);
      currentUserId = currentUser._id || currentUser.id;
      console.log('üë§ Sesi√≥n recuperada:', currentUser.email);
      showApp();
    } catch (e) {
      console.warn('No se pudo parsear usuario guardado:', e);
      localStorage.removeItem('archivosya_user');
    }
  }
});

/* ================== LOGIN / REGISTER UI ================== */
function switchTab(tab) {
  document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
  if (tab === 'login') {
    document.getElementById('tabLogin').classList.add('active');
    document.getElementById('loginForm').classList.add('active');
  } else {
    document.getElementById('tabRegister').classList.add('active');
    document.getElementById('registerForm').classList.add('active');
  }
  hideMessages();
}

function showError(msg) { 
  const el = document.getElementById('loginError'); 
  el.textContent = msg; 
  el.classList.add('show'); 
}

function showSuccess(msg) { 
  const el = document.getElementById('loginSuccess'); 
  el.textContent = msg; 
  el.classList.add('show'); 
}

function hideMessages() { 
  document.getElementById('loginError').classList.remove('show'); 
  document.getElementById('loginSuccess').classList.remove('show'); 
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  if (!email) { showError('Ingresa un email'); return; }
  try {
    const res = await fetch(`${API_URL}/auth/login`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email })
    });
    const data = await res.json();
    if (res.ok && data.user) {
      currentUser = data.user;
      currentUserId = currentUser._id || currentUser.id;
      localStorage.setItem('archivosya_user', JSON.stringify(currentUser));
      showSuccess('¬°Inicio de sesi√≥n exitoso!');
      setTimeout(() => showApp(), 700);
    } else {
      showError(data.error || 'Credenciales inv√°lidas');
    }
  } catch (err) {
    console.error('Error login:', err);
    showError('Error al conectar con el servidor');
  }
}

async function handleRegister(e) {
  e.preventDefault();
  const nombreUsuario = document.getElementById('registerName').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  if (!nombreUsuario || !email) { showError('Completa los datos'); return; }
  try {
    const res = await fetch(`${API_URL}/auth/register`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ nombreUsuario, email })
    });
    const data = await res.json();
    if (res.ok && data.user) {
      currentUser = data.user;
      currentUserId = currentUser._id || currentUser.id;
      localStorage.setItem('archivosya_user', JSON.stringify(currentUser));
      showSuccess('Cuenta creada correctamente');
      setTimeout(() => showApp(), 700);
    } else {
      showError(data.error || 'Error en el registro');
    }
  } catch (err) {
    console.error('Error register:', err);
    showError('Error al conectar con el servidor');
  }
}

function handleLogout() {
  if (!confirm('¬øCerrar sesi√≥n?')) return;
  localStorage.removeItem('archivosya_user');
  currentUser = null; currentUserId = null;
  document.getElementById('appContainer').classList.remove('active');
  document.getElementById('loginContainer').style.display = 'flex';
  document.getElementById('loginForm').reset();
  document.getElementById('registerForm').reset();
  hideMessages();
}

function showApp() {
  if (!currentUser) return;
  document.getElementById('loginContainer').style.display = 'none';
  const app = document.getElementById('appContainer');
  app.classList.add('active');
  app.setAttribute('aria-hidden', 'false');
  updateUserUI();
  loadFiles();
}

function updateUserUI() {
  if (!currentUser) return;
  document.getElementById('userName').textContent = currentUser.nombreUsuario || currentUser.name || 'Usuario';
  document.getElementById('userEmail').textContent = currentUser.email || '';
  const avatar = document.getElementById('userAvatar');
  const initial = (currentUser.nombreUsuario || currentUser.email || 'U')[0].toUpperCase();
  avatar.textContent = initial;
}

function toggleUserMenu(force) {
  const menu = document.getElementById('userMenu');
  if (force === undefined) menu.classList.toggle('active');
  else menu.classList.toggle('active', Boolean(force));
}

document.addEventListener('click', (e) => {
  const userSection = document.getElementById('userSection');
  if (userSection && !userSection.contains(e.target)) toggleUserMenu(false);
});

/* ================== UTIL: CARGA / UI ================== */
function showLoading() { 
  document.getElementById('loadingIndicator').classList.remove('hidden'); 
  document.getElementById('filesContainer').classList.add('hidden'); 
  document.getElementById('emptyState').classList.add('hidden'); 
}

function hideLoading() { 
  document.getElementById('loadingIndicator').classList.add('hidden'); 
  document.getElementById('filesContainer').classList.remove('hidden'); 
}

function showEmptyState() { 
  document.getElementById('emptyState').classList.remove('hidden'); 
  document.getElementById('filesContainer').classList.add('hidden'); 
}

function hideEmptyState() { 
  document.getElementById('emptyState').classList.add('hidden'); 
  document.getElementById('filesContainer').classList.remove('hidden'); 
}

function updateAutosaveIndicator(text) {
  const indicator = document.getElementById('autosaveIndicator');
  if (!indicator) return;
  indicator.textContent = text;
  indicator.className = 'autosave-indicator';
  if (text.includes('Guardando')) indicator.classList.add('saving');
  if (text.includes('Guardado')) indicator.classList.add('saved');
}

/* ================== RENDER & INTERACCI√ìN DE ARCHIVOS ================== */
async function loadFiles(folderId = null) {
  if (!currentUser) return;
  showLoading();
  currentFolderId = folderId || currentUser.carpetaPersonalId || 'root';
  try {
    const [filesRes, foldersRes] = await Promise.all([
      fetch(`${API_URL}/files/folder/${currentFolderId || 'root'}`).then(r => r.json()),
      fetch(`${API_URL}/folders?parentId=${currentFolderId || 'root'}`).then(r => r.json())
    ]);
    const files = Array.isArray(filesRes) ? filesRes : (filesRes.files || []);
    const folders = Array.isArray(foldersRes) ? foldersRes : (foldersRes.folders || []);
    const items = [ ...folders.map(f => ({ ...f, type: 'folder' })), ...files.map(f => ({ ...f, type: 'file' })) ];
    hideLoading();
    if (!items || items.length === 0) { showEmptyState(); return; }
    hideEmptyState();
    renderFiles(items);
  } catch (err) {
    console.error('Error loadFiles:', err);
    hideLoading();
    alert('Error al cargar archivos (revisa la consola).');
  }
}

function renderFiles(items, modo = 'normal') {
  const container = document.getElementById('filesContainer');
  container.innerHTML = '';
  items.forEach(item => {
    const isFolder = item.type === 'folder' || item.tipo === 'carpeta';
    const itemId = item._id || item.id || item.targetId || item.folderId || item._id;
    const icon = isFolder ? 'üìÅ' : 'üìÑ';
    const card = document.createElement('div');
    card.className = 'file-card';
    card.dataset.id = itemId;
    if (item.locked) card.classList.add('locked');
    const left = document.createElement('div');
    left.style.display = 'flex'; left.style.alignItems = 'center';
    left.innerHTML = `
      <div class="file-icon ${isFolder ? 'folder' : 'file'}">${icon}</div>
      <div style="min-width:0">
        <div style="font-weight:600; font-size:14px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          ${escapeHtml(item.name || item.nombre || '(sin nombre)')}
        </div>
        <div style="font-size:12px; color:#777;">${isFolder ? 'Carpeta' : (item.mimeType || '')}</div>
      </div>
    `;
    left.onclick = () => {
      if (isFolder) loadFiles(itemId);
      else openFile({ ...item, _id: itemId });
    };
    const right = document.createElement('div');
    right.style.display = 'flex'; right.style.gap = '8px';
    if (!isFolder) {
      const btnOpen = document.createElement('button');
      btnOpen.className = 'btn btn-secondary';
      btnOpen.textContent = 'Abrir';
      btnOpen.onclick = (e) => { e.stopPropagation(); openFile({ ...item, _id: itemId }); };
      right.appendChild(btnOpen);
    }
    if (modo !== 'shared') {
      const btnShare = document.createElement('button');
      btnShare.className = 'btn btn-primary';
      btnShare.textContent = 'Compartir';
      btnShare.onclick = (e) => { e.stopPropagation(); openShareModal(itemId); };
      right.appendChild(btnShare);
    }
    card.appendChild(left);
    card.appendChild(right);
    container.appendChild(card);
  });
}

/* ================== ‚úÖ APERTURA / SINCRO TIEMPO REAL ================== */
async function openFile(file) {
  const fileId = file?._id || file?.id || file?.targetId;
  if (!fileId) return alert('Archivo sin ID.');

  if (ydoc) await closeAndUnlockEditModal();
  currentFileId = fileId;
  const textarea = document.getElementById('editContent');
  textarea.value = 'Cargando...';
  updateAutosaveIndicator('Conectando...');

  // 1Ô∏è‚É£ Crear documento Yjs local
  ydoc = new Y.Doc();
  let ytext = ydoc.getText('content'); // ‚úÖ Inicializar inmediatamente

  // 2Ô∏è‚É£ Unirse al archivo
  socket.emit('file:join', { fileId, userId: currentUserId });

  // 3Ô∏è‚É£ Esperar estado inicial
  socket.once('file:init-state', async ({ fileId: incomingFileId, state }) => {
    if (incomingFileId !== currentFileId || !ydoc) return;
    
    // Aplicar estado inicial SIN bloquear eventos
    Y.applyUpdate(ydoc, new Uint8Array(state));
    textarea.value = ytext.toString(); // ‚úÖ Actualizar UI
    
    updateAutosaveIndicator('üíæ Se guarda autom√°ticamente');
    
    // Cargar metadatos (igual que antes)
    const metaRes = await fetch(`${API_URL}/files/${fileId}?userId=${currentUserId}`);
    const meta = await metaRes.json();
    document.getElementById('editName').textContent = meta.name || 'Sin nombre';
    
    const permRes = await fetch(`${API_URL}/files/permisos/${fileId}?userId=${currentUserId}`);
    const permisoDefinitivo = parseInt(await permRes.text()) || 4;
    applyPermissionToEditor(permisoDefinitivo);
  });

  // 4Ô∏è‚É£ ‚úÖ CORRECTO: Observar cambios en Y.Text
  const observer = (event) => {
    // Solo enviar si NO es un cambio local (evita loops)
    if (event.transaction.origin !== 'user-input') {
      const update = Y.encodeStateAsUpdate(ydoc);
      socket.emit('yjs-update', { 
        fileId: currentFileId, 
        update: Array.from(update) 
      });
    }
    // Siempre actualizar el textarea
    textarea.value = ytext.toString();
  };
  ytext.observe(observer);

  // 5Ô∏è‚É£ Sincronizar textarea ‚Üí Yjs
  let lastContent = textarea.value;
  const handleInput = () => {
    const newContent = textarea.value;
    if (newContent === lastContent) return;
    
    lastContent = newContent;
    
    // Aplicar cambios a Yjs (marcar como 'user-input' para evitar enviar al servidor)
    ydoc.transact(() => {
      ytext.delete(0, ytext.length);
      ytext.insert(0, newContent);
    }, 'user-input'); // üëà ¬°CLAVE! Marcar como origen local
    
    updateAutosaveIndicator('‚è≥ Guardando...');
  };
  textarea.addEventListener('input', handleInput);

  // 6Ô∏è‚É£ Recibir updates remotos
  const handleRemoteUpdate = ({ fileId: fid, update }) => {
    if (fid !== currentFileId || !ydoc) return;
    
    Y.applyUpdate(ydoc, new Uint8Array(update));
    textarea.value = ytext.toString();
    
    updateAutosaveIndicator('‚úÖ Sincronizado');
    setTimeout(() => updateAutosaveIndicator('üíæ Se guarda autom√°ticamente'), 1500);
  };
  socket.on('yjs-update', handleRemoteUpdate);

  // 7Ô∏è‚É£ Limpieza
  window.__cleanupYjs = () => {
    socket.off('yjs-update', handleRemoteUpdate);
    ytext.unobserve(observer);
    textarea.removeEventListener('input', handleInput);
    ydoc.destroy();
    ydoc = null;
  };

  showModal('editModal');
}

function applyPermissionToEditor(permiso) {
  const textarea = document.getElementById('editContent');
  const isReadOnly = (permiso === 4);
  textarea.readOnly = isReadOnly;
  textarea.style.backgroundColor = isReadOnly ? '#f8f9fa' : '#fff';
  if (isReadOnly) {
    updateAutosaveIndicator('üîí Solo lectura');
  }
}

/* ================== CERRADO SEGURO ================== */
async function closeAndUnlockEditModal() {
  if (currentFileId && currentUserId) {
    socket.emit('file:leave', { fileId: currentFileId, userId: currentUserId });
  }

  if (typeof window.__cleanupYjs === 'function') {
    window.__cleanupYjs();
    window.__cleanupYjs = null;
  }

  currentFileId = null;
  closeModal('editModal');
}

function closeModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.remove('active');
  modal.setAttribute('aria-hidden', 'true');
}

function showModal(modalId) {
  const modal = document.getElementById(modalId);
  modal.classList.add('active');
  modal.setAttribute('aria-hidden', 'false');
}

/* ================== CREAR / COMPARTIR / OTROS ================== */
async function createNew() {
  const type = document.getElementById('newType').value;
  const name = document.getElementById('newName').value.trim();
  if (!name) { alert('Ingresa un nombre.'); return; }
  try {
    const endpoint = type === 'file' ? 'files' : 'folders';
    const body = type === 'file' ? { name, userId: currentUserId, folderId: currentFolderId } : { name, userId: currentUserId, parentId: currentFolderId };
    const res = await fetch(`${API_URL}/${endpoint}`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
    });
    if (res.ok) {
      closeModal('newModal');
      document.getElementById('newName').value = '';
      loadFiles(currentFolderId);
    } else {
      const err = await res.text().catch(()=>null);
      console.error('createNew failed', err);
      alert('Error al crear (revisa consola).');
    }
  } catch (err) {
    console.error('Error createNew:', err);
    alert('No se pudo crear (revisa consola).');
  }
}

function openShareModal(targetId) {
  selectedShareTargetId = targetId;
  document.getElementById('shareEmail').value = '';
  document.getElementById('sharePermission').value = '4';
  showModal('shareModal');
}

function closeShareModal() {
  selectedShareTargetId = null;
  closeModal('shareModal');
}

document.getElementById('cancelShareBtn').addEventListener('click', closeShareModal);
document.getElementById('confirmShareBtn').addEventListener('click', async () => {
  const email = document.getElementById('shareEmail').value.trim();
  const permiso = Number(document.getElementById('sharePermission').value);
  if (!email) { alert('Ingresa un email v√°lido'); return; }
  if (!selectedShareTargetId) { alert('No hay archivo seleccionado'); return; }
  await compartirArchivo(currentUserId, selectedShareTargetId, email, permiso);
  closeShareModal();
});

async function compartirArchivo(ownerId, targetId, destinatarioEmail, permiso) {
  try {
    const res = await fetch(`${API_URL}/compartidos/compartir`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ownerId, targetId, destinatarioEmail, permiso })
    });
    if (!res.ok) { const t = await res.text(); throw new Error(t || 'HTTP ' + res.status); }
    const data = await res.json();
    alert(data.message || 'Compartido correctamente');
    return data.ref;
  } catch (err) {
    console.error('compartirArchivo error:', err);
    alert('No se pudo compartir (revisa consola).');
  }
}

async function loadShared() {
  showLoading();
  try {
    if (!currentUserId) throw new Error('No hay usuario');
    const items = await obtenerCompartidos(currentUserId);
    hideLoading();
    if (!items || items.length === 0) { showEmptyState(); return; }
    hideEmptyState();
    renderFiles(items, 'shared');
  } catch (err) {
    console.error('loadShared error:', err);
    hideLoading();
    alert('Error al cargar compartidos');
  }
}

async function obtenerCompartidos(userId) {
  const res = await fetch(`${API_URL}/compartidos/${userId}`);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return await res.json();
}

function showProfile() {
  if (!currentUser) return;
  alert(`Perfil\nNombre: ${currentUser.nombreUsuario || currentUser.name}\nEmail: ${currentUser.email}`);
  toggleUserMenu(false);
}

function escapeHtml(s) {
  if (s === undefined || s === null) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));
}

window.addEventListener('beforeunload', (e) => {
  if (currentFileId) {
    e.preventDefault();
    e.returnValue = '';
  }
});

function showNewModal() {
  document.getElementById('newName').value = '';
  document.getElementById('newType').value = 'file';
  showModal('newModal');
  setTimeout(() => {
    const inp = document.getElementById('newName');
    if (inp) inp.focus();
  }, 150);
}
</script>
</body>
</html>