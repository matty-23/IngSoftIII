
import { connectDB, disconnectDB } from './conexion';
import { FileModel } from './Esquemas/DocumentoEsquema';
import { FolderModel } from './Esquemas/DirectorioEsquema';
import { PermissionModel } from './Esquemas/PermisosEsquema';
import { VersionModel } from './Esquemas/VersionEsquema';
import { AuditLogModel } from './Esquemas/AuditoriaEsquema';

async function testDatabase() {
    console.log('üß™ Iniciando prueba de base de datos...\n');
    
    try {
        await connectDB();
        
        // 1. Limpiar colecciones (solo para testing)
        console.log('üßπ Limpiando colecciones...');
        await Promise.all([
            FileModel.deleteMany({}),
            FolderModel.deleteMany({}),
            PermissionModel.deleteMany({}),
            VersionModel.deleteMany({}),
            AuditLogModel.deleteMany({})
        ]);
        console.log('‚úÖ Colecciones limpiadas\n');
        
        // 2. Crear carpeta ra√≠z
        console.log('üìÅ Creando carpeta de prueba...');
        const folder = await FolderModel.create({
            name: 'Carpeta Test',
            parentId: null,
            ownerId: 'user-test-123'
        });
        console.log('‚úÖ Carpeta creada:', folder.name, '\n');
        
        // 3. Crear archivo
        console.log('üìÑ Creando archivo de prueba...');
        const file = await FileModel.create({
            name: 'documento-test.txt',
            content: 'Este es un contenido de prueba',
            folderId: folder._id,
            ownerId: 'user-test-123',
            state: 'idle',
            version: 1
        });
        console.log('‚úÖ Archivo creado:', file.name);
        console.log('   Tama√±o:', file.size, 'bytes\n');
        
        // 4. Crear permiso
        console.log('üîê Creando permiso de prueba...');
        const permission = await PermissionModel.create({
            resourceId: file._id,
            resourceType: 'file',
            userId: 'user-test-123',
            role: 'owner',
            grantedBy: 'system'
        });
        console.log('‚úÖ Permiso creado:', permission.role, '\n');
        
        // 5. Crear versi√≥n
        console.log('üìù Creando versi√≥n de prueba...');
        const version = await VersionModel.create({
            fileId: file._id,
            versionNumber: 1,
            content: file.content,
            createdBy: 'user-test-123'
        });
        console.log('‚úÖ Versi√≥n creada: v' + version.versionNumber);
        console.log('   Tama√±o:', version.size, 'bytes\n');
        
        // 6. Crear log de auditor√≠a
        console.log('üìã Creando log de auditor√≠a...');
        const audit = await AuditLogModel.create({
            userId: 'user-test-123',
            action: 'create',
            resourceId: file._id,
            resourceType: 'file',
            resourceName: file.name
        });
        console.log('‚úÖ Auditor√≠a creada:', audit.action, '\n');
        
        // 7. Verificar datos
        console.log('üîç Verificando datos...');
        const fileCount = await FileModel.countDocuments();
        const folderCount = await FolderModel.countDocuments();
        const permissionCount = await PermissionModel.countDocuments();
        const versionCount = await VersionModel.countDocuments();
        const auditCount = await AuditLogModel.countDocuments();
        
        console.log('üìä Estad√≠sticas:');
        console.log('   Archivos:', fileCount);
        console.log('   Carpetas:', folderCount);
        console.log('   Permisos:', permissionCount);
        console.log('   Versiones:', versionCount);
        console.log('   Logs auditor√≠a:', auditCount);
        
        console.log('\n‚úÖ ¬°Prueba completada exitosamente!');
        
    } catch (error) {
        console.error('‚ùå Error en la prueba:', error);
    } finally {
        await disconnectDB();
    }
}

// Ejecutar
testDatabase();
